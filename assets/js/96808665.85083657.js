"use strict";(globalThis.webpackChunkdocs_enclave_kubernerdes_com=globalThis.webpackChunkdocs_enclave_kubernerdes_com||[]).push([[643],{5346(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"day-2/backup-maintenance","title":"Backup & Maintenance","description":"Backup Strategy Overview","source":"@site/docs/day-2/backup-maintenance.md","sourceDirName":"day-2","slug":"/day-2/backup-maintenance","permalink":"/docs/day-2/backup-maintenance","draft":false,"unlisted":false,"editUrl":"https://github.com/jradtke-rgs/docs.enclave.kubernerdes.com/edit/main/docs/day-2/backup-maintenance.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"backup-maintenance","title":"Backup & Maintenance","sidebar_label":"Backup & Maintenance","sidebar_position":3},"sidebar":"enclaveSidebar","previous":{"title":"Monitoring","permalink":"/docs/day-2/monitoring"},"next":{"title":"Troubleshooting","permalink":"/docs/day-2/troubleshooting"}}');var r=s(4848),c=s(8453);const t={id:"backup-maintenance",title:"Backup & Maintenance",sidebar_label:"Backup & Maintenance",sidebar_position:3},i="Backup & Maintenance",l={},d=[{value:"Backup Strategy Overview",id:"backup-strategy-overview",level:2},{value:"<code>backup_hosts.sh</code> Script",id:"backup_hostssh-script",level:2},{value:"Ansible-Based Config Management",id:"ansible-based-config-management",level:2},{value:"Repository Structure",id:"repository-structure",level:3},{value:"Common Playbook Runs",id:"common-playbook-runs",level:3},{value:"Adding a New DHCP Static Lease",id:"adding-a-new-dhcp-static-lease",level:3},{value:"Longhorn Backups",id:"longhorn-backups",level:2},{value:"K3s etcd Snapshots (Rancher Manager)",id:"k3s-etcd-snapshots-rancher-manager",level:2},{value:"Harvester Upgrade",id:"harvester-upgrade",level:2},{value:"Rancher Manager Upgrade",id:"rancher-manager-upgrade",level:2},{value:"System Patching (openSUSE Leap)",id:"system-patching-opensuse-leap",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"backup--maintenance",children:"Backup & Maintenance"})}),"\n",(0,r.jsx)(n.h2,{id:"backup-strategy-overview",children:"Backup Strategy Overview"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"What"}),(0,r.jsx)(n.th,{children:"Method"}),(0,r.jsx)(n.th,{children:"Frequency"}),(0,r.jsx)(n.th,{children:"Stored"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"nuc-00 config files"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"backup_hosts.sh"})," script"]}),(0,r.jsx)(n.td,{children:"Weekly"}),(0,r.jsx)(n.td,{children:"NFS/external or git"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"infra VM configs"}),(0,r.jsx)(n.td,{children:"Ansible playbooks in git"}),(0,r.jsx)(n.td,{children:"On change"}),(0,r.jsx)(n.td,{children:"GitHub"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Harvester VM volumes"}),(0,r.jsx)(n.td,{children:"Longhorn snapshots + backup"}),(0,r.jsx)(n.td,{children:"Daily"}),(0,r.jsx)(n.td,{children:"NFS backup target"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Harvester cluster config"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"kubectl get -o yaml"})," export"]}),(0,r.jsx)(n.td,{children:"Weekly"}),(0,r.jsx)(n.td,{children:"Git"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Rancher config"}),(0,r.jsx)(n.td,{children:"Helm values + kubectl export"}),(0,r.jsx)(n.td,{children:"On change"}),(0,r.jsx)(n.td,{children:"Git"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"etcd snapshot"}),(0,r.jsx)(n.td,{children:"K3s auto-snapshot"}),(0,r.jsx)(n.td,{children:"Daily"}),(0,r.jsx)(n.td,{children:"Local + NFS"})]})]})]}),"\n",(0,r.jsxs)(n.h2,{id:"backup_hostssh-script",children:[(0,r.jsx)(n.code,{children:"backup_hosts.sh"})," Script"]}),"\n",(0,r.jsx)(n.p,{children:"The enclave repo includes a script that archives key configuration directories from all hosts."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'#!/usr/bin/env bash\n# backup_hosts.sh \u2014 archive config from all enclave hosts\n\nset -euo pipefail\n\nBACKUP_DIR="${BACKUP_DIR:-/backup/enclave}"\nDATE=$(date +%Y%m%d-%H%M%S)\nHOSTS=(nuc-00 nuc-00-01 nuc-00-02 nuc-00-03)\n\nmkdir -p "${BACKUP_DIR}/${DATE}"\n\nfor host in "${HOSTS[@]}"; do\n  echo "Backing up ${host}..."\n  tar czf "${BACKUP_DIR}/${DATE}/${host}-config.tar.gz" \\\n    --exclude=\'*.log\' \\\n    -C / \\\n    etc/NetworkManager \\\n    etc/dhcp \\\n    etc/named \\\n    etc/haproxy \\\n    etc/keepalived \\\n    etc/httpd \\\n    etc/libvirt \\\n    root/.ssh/authorized_keys\ndone\n\necho "Backup complete: ${BACKUP_DIR}/${DATE}"\n\n# Prune backups older than 30 days\nfind "${BACKUP_DIR}" -maxdepth 1 -type d -mtime +30 -exec rm -rf {} +\n'})}),"\n",(0,r.jsx)(n.p,{children:"Run it:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"chmod +x backup_hosts.sh\nBACKUP_DIR=/mnt/backup/enclave ./backup_hosts.sh\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Add to cron on ",(0,r.jsx)(n.code,{children:"nuc-00"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"crontab -e\n# Add:\n0 2 * * 0 BACKUP_DIR=/mnt/backup/enclave /root/scripts/backup_hosts.sh >> /var/log/enclave-backup.log 2>&1\n"})}),"\n",(0,r.jsx)(n.h2,{id:"ansible-based-config-management",children:"Ansible-Based Config Management"}),"\n",(0,r.jsx)(n.p,{children:"The enclave source repo uses Ansible to manage all host configurations. After any manual change to a host, run the corresponding playbook to reconcile state and commit the changes."}),"\n",(0,r.jsx)(n.h3,{id:"repository-structure",children:"Repository Structure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"enclave.kubernerdes.com/\n\u251c\u2500\u2500 Ansible/\n\u2502   \u251c\u2500\u2500 hosts               # inventory file\n\u2502   \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 Files/\n\u2502   \u251c\u2500\u2500 nuc-00-01/          # DHCP, DNS configs\n\u2502   \u251c\u2500\u2500 nuc-00-02/          # DNS secondary configs\n\u2502   \u2514\u2500\u2500 nuc-00-03/          # HAProxy, Keepalived configs\n\u2514\u2500\u2500 Scripts/\n    \u2514\u2500\u2500 ...\n"})}),"\n",(0,r.jsx)(n.h3,{id:"common-playbook-runs",children:"Common Playbook Runs"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Full site configuration\nansible-playbook -i Ansible/hosts site.yml\n\n# Only infrastructure VMs\nansible-playbook -i Ansible/hosts infra-vms.yml\n\n# Check mode (dry run)\nansible-playbook -i Ansible/hosts site.yml --check --diff\n"})}),"\n",(0,r.jsx)(n.h3,{id:"adding-a-new-dhcp-static-lease",children:"Adding a New DHCP Static Lease"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Find the MAC address of the new device"}),"\n",(0,r.jsxs)(n.li,{children:["Edit the DHCP config on ",(0,r.jsx)(n.code,{children:"nuc-00-01"})," at ",(0,r.jsx)(n.code,{children:"/etc/dhcp/dhcpd.conf"}),":"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'host new-device {\n  hardware ethernet AA:BB:CC:DD:EE:FF;\n  fixed-address 10.10.12.25;\n  option host-name "new-device";\n}\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Restart DHCP:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"systemctl restart dhcpd\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:"Commit the config change to the repo:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'git add Files/nuc-00-01/etc/dhcp/dhcpd.conf\ngit commit -m "Add static DHCP lease for new-device"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"longhorn-backups",children:"Longhorn Backups"}),"\n",(0,r.jsx)(n.p,{children:"Configure an NFS backup target in Longhorn for VM volume backups:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Harvester UI \u2192 ",(0,r.jsx)(n.strong,{children:"Advanced"})," \u2192 ",(0,r.jsx)(n.strong,{children:"Settings"})," \u2192 ",(0,r.jsx)(n.strong,{children:"backup-target"})]}),"\n",(0,r.jsxs)(n.li,{children:["Set: ",(0,r.jsx)(n.code,{children:"nfs://10.10.12.10/backup/longhorn"})," (or S3 endpoint)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Or via kubectl:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'kubectl patch setting backup-target -n longhorn-system \\\n  --type merge \\\n  -p \'{"value":"nfs://10.10.12.10/backup/longhorn"}\'\n'})}),"\n",(0,r.jsx)(n.p,{children:"Create recurring snapshots:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Create a recurring job: daily snapshot, retain 7\ncat << 'EOF' | kubectl apply -f -\napiVersion: longhorn.io/v1beta2\nkind: RecurringJob\nmetadata:\n  name: daily-snapshot\n  namespace: longhorn-system\nspec:\n  cron: \"0 1 * * *\"\n  task: snapshot\n  retain: 7\n  concurrency: 1\nEOF\n"})}),"\n",(0,r.jsx)(n.h2,{id:"k3s-etcd-snapshots-rancher-manager",children:"K3s etcd Snapshots (Rancher Manager)"}),"\n",(0,r.jsx)(n.p,{children:"K3s on the Rancher cluster automatically takes etcd snapshots. Verify and manage:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# On rancher-01 (or any Rancher K3s node)\n# List local snapshots\nls -lh /var/lib/rancher/k3s/server/db/snapshots/\n\n# K3s config for snapshot schedule (in /etc/rancher/k3s/config.yaml)\ncat << 'EOF' > /etc/rancher/k3s/config.yaml\netcd-snapshot-schedule-cron: \"0 2 * * *\"\netcd-snapshot-retain: 7\netcd-snapshot-dir: /var/lib/rancher/k3s/server/db/snapshots\nEOF\n\nsystemctl restart k3s\n"})}),"\n",(0,r.jsx)(n.p,{children:"Copy snapshots off the VM:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"scp mansible@10.10.12.211:/var/lib/rancher/k3s/server/db/snapshots/\\* \\\n  /mnt/backup/enclave/rancher-etcd/\n"})}),"\n",(0,r.jsx)(n.h2,{id:"harvester-upgrade",children:"Harvester Upgrade"}),"\n",(0,r.jsx)(n.p,{children:"Upgrades are managed through the Harvester UI:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Harvester UI \u2192 ",(0,r.jsx)(n.strong,{children:"Dashboard"})," \u2192 ",(0,r.jsx)(n.strong,{children:"Upgrade"})," (appears when new version is available)"]}),"\n",(0,r.jsxs)(n.li,{children:["Review release notes at ",(0,r.jsx)(n.a,{href:"https://github.com/harvester/harvester/releases",children:"https://github.com/harvester/harvester/releases"})]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Start Upgrade"})]}),"\n",(0,r.jsx)(n.li,{children:"Harvester upgrades one node at a time, draining workloads before upgrading each node"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Manual upgrade via kubectl:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cat << 'EOF' | kubectl apply -f -\napiVersion: harvesterhci.io/v1beta1\nkind: Upgrade\nmetadata:\n  name: hvst-upgrade-v1-7-x\n  namespace: harvester-system\nspec:\n  version: v1.7.x\n  image: rancher/harvester:v1.7.x\nEOF\n"})}),"\n",(0,r.jsx)(n.h2,{id:"rancher-manager-upgrade",children:"Rancher Manager Upgrade"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"helm repo update\n\n# Check current version\nhelm list -n cattle-system --kubeconfig ~/.kube/rancher-k3s-config\n\n# Upgrade\nhelm upgrade rancher rancher-prime/rancher \\\n  --namespace cattle-system \\\n  --kubeconfig ~/.kube/rancher-k3s-config \\\n  --reuse-values \\\n  --version <new-version>\n\n# Monitor rollout\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  rollout status deployment rancher -n cattle-system\n"})}),"\n",(0,r.jsx)(n.h2,{id:"system-patching-opensuse-leap",children:"System Patching (openSUSE Leap)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Run on nuc-00 and all VMs via Ansible\nansible-playbook -i Ansible/hosts patch.yml\n\n# Or manually on each host\nzypper --non-interactive update\nsystemctl reboot  # if kernel was updated\n"})}),"\n",(0,r.jsxs)(n.p,{children:["After rebooting ",(0,r.jsx)(n.code,{children:"nuc-00"}),", the infra VMs (",(0,r.jsx)(n.code,{children:"nuc-00-01"}),", ",(0,r.jsx)(n.code,{children:"nuc-00-02"}),", ",(0,r.jsx)(n.code,{children:"nuc-00-03"}),") are also rebooted \u2014 there will be a brief DHCP/DNS/VIP outage. Plan this during a maintenance window."]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453(e,n,s){s.d(n,{R:()=>t,x:()=>i});var a=s(6540);const r={},c=a.createContext(r);function t(e){const n=a.useContext(c);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),a.createElement(c.Provider,{value:n},e.children)}}}]);