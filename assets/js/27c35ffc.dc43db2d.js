"use strict";(globalThis.webpackChunkdocs_enclave_kubernerdes_com=globalThis.webpackChunkdocs_enclave_kubernerdes_com||[]).push([[728],{3992(n,e,r){r.r(e),r.d(e,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"day-1/infrastructure-vms","title":"Infrastructure VMs","description":"Three VMs run on nuc-00 providing shared infrastructure services:","source":"@site/docs/day-1/infrastructure-vms.md","sourceDirName":"day-1","slug":"/day-1/infrastructure-vms","permalink":"/docs/day-1/infrastructure-vms","draft":false,"unlisted":false,"editUrl":"https://github.com/jradtke-rgs/docs.enclave.kubernerdes.com/edit/main/docs/day-1/infrastructure-vms.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"infrastructure-vms","title":"Infrastructure VMs","sidebar_label":"Infrastructure VMs","sidebar_position":3},"sidebar":"enclaveSidebar","previous":{"title":"Admin Host","permalink":"/docs/day-1/admin-host"},"next":{"title":"Harvester Cluster","permalink":"/docs/day-1/harvester-cluster"}}');var s=r(4848),c=r(8453);const t={id:"infrastructure-vms",title:"Infrastructure VMs",sidebar_label:"Infrastructure VMs",sidebar_position:3},i="Infrastructure VMs",d={},o=[{value:"Creating the VMs",id:"creating-the-vms",level:2},{value:"nuc-00-01: ISC DHCP + BIND DNS (Primary)",id:"nuc-00-01-isc-dhcp--bind-dns-primary",level:2},{value:"ISC DHCP Configuration",id:"isc-dhcp-configuration",level:3},{value:"BIND DNS Configuration (Primary)",id:"bind-dns-configuration-primary",level:3},{value:"nuc-00-02: BIND DNS (Secondary)",id:"nuc-00-02-bind-dns-secondary",level:2},{value:"nuc-00-03: HAProxy + Keepalived",id:"nuc-00-03-haproxy--keepalived",level:2},{value:"HAProxy Configuration",id:"haproxy-configuration",level:3},{value:"Keepalived Configuration",id:"keepalived-configuration",level:3},{value:"Verification",id:"verification",level:2},{value:"nuc-00-01 checks",id:"nuc-00-01-checks",level:3},{value:"nuc-00-02 checks",id:"nuc-00-02-checks",level:3},{value:"nuc-00-03 checks",id:"nuc-00-03-checks",level:3}];function l(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,c.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"infrastructure-vms",children:"Infrastructure VMs"})}),"\n",(0,s.jsxs)(e.p,{children:["Three VMs run on ",(0,s.jsx)(e.code,{children:"nuc-00"})," providing shared infrastructure services:"]}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"VM"}),(0,s.jsx)(e.th,{children:"IP"}),(0,s.jsx)(e.th,{children:"Services"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"nuc-00-01"})}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"10.10.12.8"})}),(0,s.jsx)(e.td,{children:"ISC DHCP, BIND DNS (primary)"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"nuc-00-02"})}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"10.10.12.9"})}),(0,s.jsx)(e.td,{children:"BIND DNS (secondary)"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"nuc-00-03"})}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"10.10.12.93"})}),(0,s.jsx)(e.td,{children:"HAProxy, Keepalived"})]})]})]}),"\n",(0,s.jsx)(e.p,{children:"All VMs run openSUSE Leap 15.5."}),"\n",(0,s.jsx)(e.h2,{id:"creating-the-vms",children:"Creating the VMs"}),"\n",(0,s.jsxs)(e.p,{children:["Use ",(0,s.jsx)(e.code,{children:"virt-install"})," on ",(0,s.jsx)(e.code,{children:"nuc-00"}),":"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# nuc-00-01\nvirt-install \\\n  --name nuc-00-01 \\\n  --vcpus 4 \\\n  --memory 4096 \\\n  --disk /dev/vg-infra/lv-nuc-00-01,bus=virtio \\\n  --network bridge=virbr0,model=virtio \\\n  --os-variant opensuse15.5 \\\n  --location /var/www/html/openSUSE-Leap-15.5-DVD-x86_64.iso \\\n  --initrd-inject /root/autoyast-nuc-00-01.xml \\\n  --extra-args "autoyast=file:///autoyast-nuc-00-01.xml console=ttyS0" \\\n  --console pty,target_type=serial \\\n  --noautoconsole\n\n# nuc-00-02\nvirt-install \\\n  --name nuc-00-02 \\\n  --vcpus 2 \\\n  --memory 2048 \\\n  --disk /dev/vg-infra/lv-nuc-00-02,bus=virtio \\\n  --network bridge=virbr0,model=virtio \\\n  --os-variant opensuse15.5 \\\n  --location /var/www/html/openSUSE-Leap-15.5-DVD-x86_64.iso \\\n  --initrd-inject /root/autoyast-nuc-00-02.xml \\\n  --extra-args "autoyast=file:///autoyast-nuc-00-02.xml console=ttyS0" \\\n  --console pty,target_type=serial \\\n  --noautoconsole\n\n# nuc-00-03\nvirt-install \\\n  --name nuc-00-03 \\\n  --vcpus 2 \\\n  --memory 2048 \\\n  --disk /dev/vg-infra/lv-nuc-00-03,bus=virtio \\\n  --network bridge=virbr0,model=virtio \\\n  --os-variant opensuse15.5 \\\n  --location /var/www/html/openSUSE-Leap-15.5-DVD-x86_64.iso \\\n  --initrd-inject /root/autoyast-nuc-00-03.xml \\\n  --extra-args "autoyast=file:///autoyast-nuc-00-03.xml console=ttyS0" \\\n  --console pty,target_type=serial \\\n  --noautoconsole\n'})}),"\n",(0,s.jsx)(e.p,{children:"Enable VMs to auto-start:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"virsh autostart nuc-00-01\nvirsh autostart nuc-00-02\nvirsh autostart nuc-00-03\n"})}),"\n",(0,s.jsx)(e.h2,{id:"nuc-00-01-isc-dhcp--bind-dns-primary",children:"nuc-00-01: ISC DHCP + BIND DNS (Primary)"}),"\n",(0,s.jsx)(e.h3,{id:"isc-dhcp-configuration",children:"ISC DHCP Configuration"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Install on nuc-00-01\nzypper install -y dhcp-server bind bind-utils\n\n# /etc/dhcp/dhcpd.conf\ncat > /etc/dhcp/dhcpd.conf << \'EOF\'\nauthoritative;\ndefault-lease-time 7200;\nmax-lease-time 7200;\n\nsubnet 10.10.12.0 netmask 255.255.252.0 {\n  range 10.10.15.0 10.10.15.254;\n  option routers 10.10.12.1;\n  option domain-name-servers 10.10.12.8, 10.10.12.9, 8.8.8.8;\n  option domain-name "enclave.kubernerdes.com";\n  next-server 10.10.12.10;\n  filename "pxelinux.0";\n}\n\n# Static leases for Harvester nodes (PXE)\nhost nuc-01 {\n  hardware ethernet 48:21:0b:65:ce:e5;\n  fixed-address 10.10.12.101;\n  option host-name "nuc-01";\n}\nhost nuc-02 {\n  hardware ethernet 48:21:0b:65:c2:c7;\n  fixed-address 10.10.12.102;\n  option host-name "nuc-02";\n}\nhost nuc-03 {\n  hardware ethernet 48:21:0b:5d:7a:e6;\n  fixed-address 10.10.12.103;\n  option host-name "nuc-03";\n}\nEOF\n\nsystemctl enable --now dhcpd\n'})}),"\n",(0,s.jsx)(e.h3,{id:"bind-dns-configuration-primary",children:"BIND DNS Configuration (Primary)"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# /etc/named.conf\ncat > /etc/named.conf << \'EOF\'\noptions {\n  listen-on port 53 { any; };\n  directory "/var/named";\n  allow-query { any; };\n  recursion yes;\n  forwarders { 1.1.1.1; 8.8.8.8; };\n};\n\nzone "enclave.kubernerdes.com" IN {\n  type master;\n  file "master/db.enclave.kubernerdes.com";\n  allow-transfer { 10.10.12.9; };\n};\n\nzone "12.10.10.in-addr.arpa" IN {\n  type master;\n  file "master/db.12.10.10.in-addr.arpa";\n  allow-transfer { 10.10.12.9; };\n};\nEOF\n\n# Copy zone files (see Network Planning for content)\n# Place in /var/lib/named/master/db.enclave.kubernerdes.com\n# Place in /var/lib/named/master/db.12.10.10.in-addr.arpa\n\nnamed-checkconf\nnamed-checkzone enclave.kubernerdes.com /var/lib/named/master/db.enclave.kubernerdes.com\nsystemctl enable --now named\n'})}),"\n",(0,s.jsx)(e.h2,{id:"nuc-00-02-bind-dns-secondary",children:"nuc-00-02: BIND DNS (Secondary)"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'zypper install -y bind bind-utils\n\n# /etc/named.conf \u2014 secondary (slave) configuration\ncat > /etc/named.conf << \'EOF\'\noptions {\n  listen-on port 53 { any; };\n  directory "/var/named";\n  allow-query { any; };\n  recursion yes;\n  forwarders { 1.1.1.1; 8.8.8.8; };\n};\n\nzone "enclave.kubernerdes.com" IN {\n  type slave;\n  masters { 10.10.12.8; };\n  file "slaves/db.enclave.kubernerdes.com";\n};\n\nzone "12.10.10.in-addr.arpa" IN {\n  type slave;\n  masters { 10.10.12.8; };\n  file "slaves/db.12.10.10.in-addr.arpa";\n};\nEOF\n\nsystemctl enable --now named\n'})}),"\n",(0,s.jsx)(e.h2,{id:"nuc-00-03-haproxy--keepalived",children:"nuc-00-03: HAProxy + Keepalived"}),"\n",(0,s.jsx)(e.h3,{id:"haproxy-configuration",children:"HAProxy Configuration"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"zypper install -y haproxy keepalived\n\n# /etc/haproxy/haproxy.cfg\ncat > /etc/haproxy/haproxy.cfg << 'EOF'\nglobal\n  log stdout format raw local0\n  maxconn 4096\n\ndefaults\n  log     global\n  mode    tcp\n  option  tcplog\n  timeout connect 5s\n  timeout client  30s\n  timeout server  30s\n\n#---------------------------------------------------------------------\n# Stats page\n#---------------------------------------------------------------------\nlisten stats\n  bind *:9000\n  mode http\n  stats enable\n  stats uri /stats\n  stats refresh 10s\n  stats auth admin:rancher\n\n#---------------------------------------------------------------------\n# Rancher Manager VIP (10.10.12.210)\n#---------------------------------------------------------------------\nfrontend rancher-http\n  bind 10.10.12.210:80\n  default_backend rancher-nodes-80\n\nbackend rancher-nodes-80\n  option tcp-check\n  server rancher-01 10.10.12.211:80 check\n  server rancher-02 10.10.12.212:80 check\n  server rancher-03 10.10.12.213:80 check\n\nfrontend rancher-https\n  bind 10.10.12.210:443\n  default_backend rancher-nodes-443\n\nbackend rancher-nodes-443\n  option tcp-check\n  server rancher-01 10.10.12.211:443 check\n  server rancher-02 10.10.12.212:443 check\n  server rancher-03 10.10.12.213:443 check\n\nfrontend rancher-api\n  bind 10.10.12.210:6443\n  default_backend rancher-nodes-6443\n\nbackend rancher-nodes-6443\n  option tcp-check\n  server rancher-01 10.10.12.211:6443 check\n  server rancher-02 10.10.12.212:6443 check\n  server rancher-03 10.10.12.213:6443 check\nEOF\n\nsystemctl enable --now haproxy\n"})}),"\n",(0,s.jsx)(e.h3,{id:"keepalived-configuration",children:"Keepalived Configuration"}),"\n",(0,s.jsxs)(e.p,{children:["Keepalived manages two VIPs on ",(0,s.jsx)(e.code,{children:"nuc-00-03"}),". It is the MASTER for both."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# /etc/keepalived/keepalived.conf\ncat > /etc/keepalived/keepalived.conf << 'EOF'\nglobal_defs {\n  router_id nuc-00-03\n}\n\nvrrp_instance VI_HADRIAN {\n  state MASTER\n  interface eth0\n  virtual_router_id 193\n  priority 100\n  advert_int 1\n  authentication {\n    auth_type PASS\n    auth_pass rancher\n  }\n  virtual_ipaddress {\n    10.10.12.193/22\n  }\n}\n\nvrrp_instance VI_RANCHER {\n  state MASTER\n  interface eth0\n  virtual_router_id 210\n  priority 100\n  advert_int 1\n  authentication {\n    auth_type PASS\n    auth_pass rancher\n  }\n  virtual_ipaddress {\n    10.10.12.210/22\n  }\n}\nEOF\n\nsystemctl enable --now keepalived\n"})}),"\n",(0,s.jsx)(e.h2,{id:"verification",children:"Verification"}),"\n",(0,s.jsx)(e.h3,{id:"nuc-00-01-checks",children:"nuc-00-01 checks"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# DHCP is running\nsystemctl is-active dhcpd\n\n# DNS resolves local names\ndig @10.10.12.8 nuc-00.enclave.kubernerdes.com\ndig @10.10.12.8 rancher.enclave.kubernerdes.com\n# Expected: ANSWER SECTION with correct IPs\n\n# Reverse DNS\ndig @10.10.12.8 -x 10.10.12.10\n"})}),"\n",(0,s.jsx)(e.h3,{id:"nuc-00-02-checks",children:"nuc-00-02 checks"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Named is running and zone transferred from primary\nsystemctl is-active named\ndig @10.10.12.9 nuc-00.enclave.kubernerdes.com\n"})}),"\n",(0,s.jsx)(e.h3,{id:"nuc-00-03-checks",children:"nuc-00-03 checks"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# HAProxy running\nsystemctl is-active haproxy\ncurl http://10.10.12.93:9000/stats\n\n# VIPs are assigned\nip addr show | grep 10.10.12.193\nip addr show | grep 10.10.12.210\n\n# Keepalived running\nsystemctl is-active keepalived\n"})}),"\n",(0,s.jsxs)(e.p,{children:["All checks passing? Update ",(0,s.jsx)(e.code,{children:"nuc-00"}),"'s DNS to point to ",(0,s.jsx)(e.code,{children:"10.10.12.8"}),":"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'nmcli connection modify eth0 ipv4.dns "10.10.12.8 10.10.12.9"\nnmcli connection up eth0\n'})}),"\n",(0,s.jsxs)(e.p,{children:["Proceed to ",(0,s.jsx)(e.a,{href:"/docs/day-1/harvester-cluster",children:"Harvester Cluster"}),"."]})]})}function h(n={}){const{wrapper:e}={...(0,c.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(l,{...n})}):l(n)}},8453(n,e,r){r.d(e,{R:()=>t,x:()=>i});var a=r(6540);const s={},c=a.createContext(s);function t(n){const e=a.useContext(c);return a.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:t(n.components),a.createElement(c.Provider,{value:e},n.children)}}}]);