"use strict";(globalThis.webpackChunkdocs_enclave_kubernerdes_com=globalThis.webpackChunkdocs_enclave_kubernerdes_com||[]).push([[295],{939(e,n,s){s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"day-2/troubleshooting","title":"Troubleshooting","description":"Quick Diagnostics Checklist","source":"@site/docs/day-2/troubleshooting.md","sourceDirName":"day-2","slug":"/day-2/troubleshooting","permalink":"/docs/day-2/troubleshooting","draft":false,"unlisted":false,"editUrl":"https://github.com/jradtke-rgs/docs.enclave.kubernerdes.com/edit/main/docs/day-2/troubleshooting.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"id":"troubleshooting","title":"Troubleshooting","sidebar_label":"Troubleshooting","sidebar_position":4},"sidebar":"enclaveSidebar","previous":{"title":"Backup & Maintenance","permalink":"/docs/day-2/backup-maintenance"}}');var t=s(4848),c=s(8453);const a={id:"troubleshooting",title:"Troubleshooting",sidebar_label:"Troubleshooting",sidebar_position:4},l="Troubleshooting",i={},o=[{value:"Quick Diagnostics Checklist",id:"quick-diagnostics-checklist",level:2},{value:"Network Issues",id:"network-issues",level:2},{value:"VIP Not Reachable",id:"vip-not-reachable",level:3},{value:"HAProxy Backend Down",id:"haproxy-backend-down",level:3},{value:"DNS Not Resolving",id:"dns-not-resolving",level:3},{value:"Harvester Cluster Issues",id:"harvester-cluster-issues",level:2},{value:"Node NotReady",id:"node-notready",level:3},{value:"Longhorn Volume Degraded",id:"longhorn-volume-degraded",level:3},{value:"etcd Cluster Unhealthy",id:"etcd-cluster-unhealthy",level:3},{value:"Rancher Manager Issues",id:"rancher-manager-issues",level:2},{value:"Rancher Pods CrashLooping",id:"rancher-pods-crashlooping",level:3},{value:"K3s Node Not Joining Rancher Cluster",id:"k3s-node-not-joining-rancher-cluster",level:3},{value:"Rancher Cannot Connect to Harvester",id:"rancher-cannot-connect-to-harvester",level:3},{value:"Certificate Issues",id:"certificate-issues",level:2},{value:"cert-manager Certificate Not Issued",id:"cert-manager-certificate-not-issued",level:3},{value:"Certificate Expired",id:"certificate-expired",level:3},{value:"PXE Boot Issues",id:"pxe-boot-issues",level:2},{value:"Harvester Node Fails to PXE Boot",id:"harvester-node-fails-to-pxe-boot",level:3},{value:"Useful kubectl Snippets",id:"useful-kubectl-snippets",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"troubleshooting",children:"Troubleshooting"})}),"\n",(0,t.jsx)(n.h2,{id:"quick-diagnostics-checklist",children:"Quick Diagnostics Checklist"}),"\n",(0,t.jsx)(n.p,{children:"When something isn't working, run through these in order:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# 1. Are all Harvester nodes up?\nkubectl get nodes\n\n# 2. Are all pods running?\nkubectl get pods -A | grep -Ev "Running|Completed"\n\n# 3. Is the Harvester VIP responding?\ncurl -k https://10.10.12.100/ping  # Harvester\n\n# 4. Is the Rancher VIP responding?\ncurl -k https://10.10.12.210/ping  # Rancher\n\n# 5. Is DNS working?\ndig @10.10.12.8 rancher.enclave.kubernerdes.com\n\n# 6. Is HAProxy healthy?\ncurl http://10.10.12.93:9000/stats | grep -E "UP|DOWN"\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"network-issues",children:"Network Issues"}),"\n",(0,t.jsx)(n.h3,{id:"vip-not-reachable",children:"VIP Not Reachable"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Symptom:"})," ",(0,t.jsx)(n.code,{children:"curl https://10.10.12.210"})," times out."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check if VIP is assigned on nuc-00-03\nssh mansible@10.10.12.93 "ip addr show | grep 10.10.12.210"\n\n# If not assigned, Keepalived may have stopped\nssh mansible@10.10.12.93 "systemctl status keepalived"\nssh mansible@10.10.12.93 "journalctl -u keepalived --since \'10 min ago\'"\n\n# Restart Keepalived\nssh mansible@10.10.12.93 "systemctl restart keepalived"\n'})}),"\n",(0,t.jsx)(n.p,{children:"If Keepalived is running but VIP is still missing, check for IP conflicts:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# ARP scan for the VIP address\narping -I eth0 10.10.12.210\n"})}),"\n",(0,t.jsx)(n.h3,{id:"haproxy-backend-down",children:"HAProxy Backend Down"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Symptom:"})," HAProxy stats show backend ",(0,t.jsx)(n.code,{children:"DOWN"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check HAProxy logs\nssh mansible@10.10.12.93 "journalctl -u haproxy --since \'30 min ago\'"\n\n# Manually test backend connectivity from nuc-00-03\nssh mansible@10.10.12.93 "curl -k https://10.10.12.211:443/ping"\n'})}),"\n",(0,t.jsx)(n.p,{children:"If a Rancher node backend is down, check if the node is up:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'ping 10.10.12.211\nssh mansible@10.10.12.211 "systemctl status k3s"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"dns-not-resolving",children:"DNS Not Resolving"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Test DNS directly against nuc-00-01\ndig @10.10.12.8 nuc-01.enclave.kubernerdes.com\n\n# Check BIND logs\nssh mansible@10.10.12.8 "journalctl -u named --since \'10 min ago\'"\n\n# Reload zone after editing zone file\nssh mansible@10.10.12.8 "named-checkzone enclave.kubernerdes.com /var/lib/named/master/db.enclave.kubernerdes.com && rndc reload"\n\n# Verify secondary DNS has synced\ndig @10.10.12.9 nuc-01.enclave.kubernerdes.com\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"harvester-cluster-issues",children:"Harvester Cluster Issues"}),"\n",(0,t.jsx)(n.h3,{id:"node-notready",children:"Node NotReady"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Describe the node\nkubectl describe node nuc-02\n\n# Check k3s on the affected node\nssh rancher@10.10.12.102 "systemctl status k3s"\nssh rancher@10.10.12.102 "journalctl -u k3s --since \'15 min ago\' | tail -50"\n\n# Common fix: restart k3s\nssh rancher@10.10.12.102 "systemctl restart k3s"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"longhorn-volume-degraded",children:"Longhorn Volume Degraded"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Find degraded volumes\nkubectl get volumes -n longhorn-system \\\n  -o custom-columns='NAME:.metadata.name,ROBUSTNESS:.status.robustness' | \\\n  grep -v healthy\n\n# Describe a degraded volume\nkubectl describe volume <volume-name> -n longhorn-system\n\n# Check replica status\nkubectl get replicas -n longhorn-system | grep <volume-name>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Common causes:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"A node was recently rebooted \u2192 replicas are still rebuilding (wait 10\u201320 min)"}),"\n",(0,t.jsx)(n.li,{children:"A node is down \u2192 volume is degraded until node returns"}),"\n",(0,t.jsx)(n.li,{children:"Disk full \u2192 free space or expand disk"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"etcd-cluster-unhealthy",children:"etcd Cluster Unhealthy"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check etcd members\nssh rancher@10.10.12.101\nkubectl get pods -n kube-system | grep etcd\n\n# Check etcd logs\nkubectl logs -n kube-system etcd-nuc-01 --tail=50\n\n# etcd cluster health (from inside a node)\nETCDCTL_API=3 etcdctl \\\n  --endpoints=https://127.0.0.1:2379 \\\n  --cacert=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt \\\n  --cert=/var/lib/rancher/k3s/server/tls/etcd/server-client.crt \\\n  --key=/var/lib/rancher/k3s/server/tls/etcd/server-client.key \\\n  member list\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"rancher-manager-issues",children:"Rancher Manager Issues"}),"\n",(0,t.jsx)(n.h3,{id:"rancher-pods-crashlooping",children:"Rancher Pods CrashLooping"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check pod status\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  get pods -n cattle-system\n\n# Get logs from crashed pod\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  logs -n cattle-system deploy/rancher --previous\n\n# Describe pod for events\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  describe pod -n cattle-system -l app=rancher\n"})}),"\n",(0,t.jsx)(n.p,{children:"Common causes:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["cert-manager certificate not issued \u2192 see ",(0,t.jsx)(n.a,{href:"#certificate-issues",children:"Certificate Issues"})]}),"\n",(0,t.jsxs)(n.li,{children:["K3s node out of memory \u2192 check ",(0,t.jsx)(n.code,{children:"kubectl top nodes"})]}),"\n",(0,t.jsx)(n.li,{children:"Rancher DB corrupted \u2192 restore from etcd snapshot"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"k3s-node-not-joining-rancher-cluster",children:"K3s Node Not Joining Rancher Cluster"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check K3s status on the failing node\nssh mansible@10.10.12.212 "systemctl status k3s"\nssh mansible@10.10.12.212 "journalctl -u k3s --since \'15 min ago\' | tail -50"\n\n# Verify the VIP is reachable from that node\nssh mansible@10.10.12.212 "ping -c 3 10.10.12.210"\nssh mansible@10.10.12.212 "curl -k https://10.10.12.211:6443"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"rancher-cannot-connect-to-harvester",children:"Rancher Cannot Connect to Harvester"}),"\n",(0,t.jsx)(n.p,{children:'In Rancher UI, the imported Harvester cluster shows "Unavailable":'}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check cattle-cluster-agent on Harvester side\nkubectl get pods -n cattle-system\nkubectl logs -n cattle-system -l app=cattle-cluster-agent\n\n# Verify Rancher URL is reachable from Harvester nodes\nkubectl exec -n cattle-system deploy/cattle-cluster-agent -- \\\n  curl -k https://10.10.12.210/ping\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"certificate-issues",children:"Certificate Issues"}),"\n",(0,t.jsx)(n.h3,{id:"cert-manager-certificate-not-issued",children:"cert-manager Certificate Not Issued"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check certificate status\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  describe certificate -n cattle-system tls-rancher-ingress\n\n# Check CertificateRequest\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  get certificaterequests -n cattle-system\n\n# Check cert-manager logs\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  logs -n cert-manager deploy/cert-manager | tail -30\n"})}),"\n",(0,t.jsx)(n.p,{children:"For Let's Encrypt certificates, verify:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["DNS resolves ",(0,t.jsx)(n.code,{children:"rancher.enclave.kubernerdes.com"})," to a publicly routable IP (not ",(0,t.jsx)(n.code,{children:"10.10.12.210"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Port 80 is open for ACME HTTP-01 challenge"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["For air-gapped deployments with self-signed certs, use ",(0,t.jsx)(n.code,{children:"ingress.tls.source=secret"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Create a self-signed cert\nopenssl req -x509 -newkey rsa:4096 -keyout tls.key -out tls.crt \\\n  -days 365 -nodes -subj "/CN=rancher.enclave.kubernerdes.com" \\\n  -addext "subjectAltName=DNS:rancher.enclave.kubernerdes.com,IP:10.10.12.210"\n\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  create secret tls tls-rancher-ingress \\\n  --cert=tls.crt --key=tls.key \\\n  -n cattle-system\n'})}),"\n",(0,t.jsx)(n.h3,{id:"certificate-expired",children:"Certificate Expired"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check expiry\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  get certificates -A -o \\\n  custom-columns='NAME:.metadata.name,EXPIRY:.status.notAfter,READY:.status.conditions[-1].status'\n\n# Force renewal (cert-manager)\nkubectl --kubeconfig ~/.kube/rancher-k3s-config \\\n  annotate certificate tls-rancher-ingress \\\n  -n cattle-system \\\n  cert-manager.io/issue-temporary-certificate=\"true\"\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"pxe-boot-issues",children:"PXE Boot Issues"}),"\n",(0,t.jsx)(n.h3,{id:"harvester-node-fails-to-pxe-boot",children:"Harvester Node Fails to PXE Boot"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check DHCP leases on nuc-00-01\nssh mansible@10.10.12.8 "cat /var/lib/dhcpd/dhcpd.leases | grep -A5 <MAC>"\n\n# Verify TFTP is serving\ntftp 10.10.12.10 -c get pxelinux.0\n\n# Check Apache is serving Harvester files\ncurl http://10.10.12.10/harvester/\n\n# Check firewall on nuc-00\nfirewall-cmd --list-all | grep -E "tftp|http"\n'})}),"\n",(0,t.jsx)(n.p,{children:"Common fixes:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Verify the NUC's MAC address matches the DHCP static lease in ",(0,t.jsx)(n.code,{children:"/etc/dhcp/dhcpd.conf"})]}),"\n",(0,t.jsx)(n.li,{children:"Confirm BIOS boot order: Network first, Secure Boot disabled"}),"\n",(0,t.jsxs)(n.li,{children:["Check ",(0,t.jsx)(n.code,{children:"next-server"})," in dhcpd.conf points to ",(0,t.jsx)(n.code,{children:"10.10.12.10"})]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"useful-kubectl-snippets",children:"Useful kubectl Snippets"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# All pods not Running\nkubectl get pods -A --field-selector='status.phase!=Running' | grep -v Completed\n\n# Events sorted by time\nkubectl get events -A --sort-by='.lastTimestamp' | tail -20\n\n# Exec into a pod\nkubectl exec -it <pod-name> -n <namespace> -- /bin/bash\n\n# Port-forward a service for local access\nkubectl port-forward svc/longhorn-frontend 8080:80 -n longhorn-system\n\n# Get all resources in a namespace\nkubectl get all -n cattle-system\n\n# Force-delete a stuck pod\nkubectl delete pod <pod-name> -n <namespace> --grace-period=0 --force\n\n# Watch pods in real time\nwatch kubectl get pods -n cattle-system\n\n# Drain and uncordon a node\nkubectl drain nuc-02 --ignore-daemonsets --delete-emptydir-data --timeout=5m\nkubectl uncordon nuc-02\n"})})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>l});var r=s(6540);const t={},c=r.createContext(t);function a(e){const n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);