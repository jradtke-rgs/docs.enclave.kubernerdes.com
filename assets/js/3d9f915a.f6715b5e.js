"use strict";(globalThis.webpackChunkdocs_enclave_kubernerdes_com=globalThis.webpackChunkdocs_enclave_kubernerdes_com||[]).push([[559],{8347(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"day-1/harvester-cluster","title":"Harvester Cluster","description":"Three NUCs (nuc-01, nuc-02, nuc-03) form the Harvester HCI cluster. They are installed via PXE boot using automated cloud-init-style Harvester config files.","source":"@site/docs/day-1/harvester-cluster.md","sourceDirName":"day-1","slug":"/day-1/harvester-cluster","permalink":"/docs/day-1/harvester-cluster","draft":false,"unlisted":false,"editUrl":"https://github.com/jradtke-rgs/docs.enclave.kubernerdes.com/edit/main/docs/day-1/harvester-cluster.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"id":"harvester-cluster","title":"Harvester Cluster","sidebar_label":"Harvester Cluster","sidebar_position":4},"sidebar":"enclaveSidebar","previous":{"title":"Infrastructure VMs","permalink":"/docs/day-1/infrastructure-vms"},"next":{"title":"Rancher Manager","permalink":"/docs/day-1/rancher-manager"}}');var t=s(4848),o=s(8453);const c={id:"harvester-cluster",title:"Harvester Cluster",sidebar_label:"Harvester Cluster",sidebar_position:4},i="Harvester Cluster",a={},l=[{value:"How Harvester PXE Boot Works",id:"how-harvester-pxe-boot-works",level:2},{value:"Per-Node Config Files",id:"per-node-config-files",level:2},{value:"<code>config-create-nuc-01.yaml</code> (First Node \u2014 Creates Cluster)",id:"config-create-nuc-01yaml-first-node--creates-cluster",level:3},{value:"<code>config-join-nuc-02.yaml</code> (Join Node)",id:"config-join-nuc-02yaml-join-node",level:3},{value:"Generate Hashed Password",id:"generate-hashed-password",level:3},{value:"Installation Sequence",id:"installation-sequence",level:2},{value:"Step 1: Boot nuc-01",id:"step-1-boot-nuc-01",level:3},{value:"Step 2: Verify nuc-01 is up",id:"step-2-verify-nuc-01-is-up",level:3},{value:"Step 3: Boot nuc-02 and nuc-03",id:"step-3-boot-nuc-02-and-nuc-03",level:3},{value:"Step 4: Retrieve kubeconfig",id:"step-4-retrieve-kubeconfig",level:3},{value:"Cluster Verification",id:"cluster-verification",level:2},{value:"Post-Install: Add Longhorn Disks",id:"post-install-add-longhorn-disks",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"harvester-cluster",children:"Harvester Cluster"})}),"\n",(0,t.jsxs)(n.p,{children:["Three NUCs (",(0,t.jsx)(n.code,{children:"nuc-01"}),", ",(0,t.jsx)(n.code,{children:"nuc-02"}),", ",(0,t.jsx)(n.code,{children:"nuc-03"}),") form the Harvester HCI cluster. They are installed via PXE boot using automated ",(0,t.jsx)(n.code,{children:"cloud-init"}),"-style Harvester config files."]}),"\n",(0,t.jsx)(n.h2,{id:"how-harvester-pxe-boot-works",children:"How Harvester PXE Boot Works"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["NUC powers on \u2192 DHCP assigns IP + ",(0,t.jsx)(n.code,{children:"next-server"})," + ",(0,t.jsx)(n.code,{children:"filename"})]}),"\n",(0,t.jsxs)(n.li,{children:["NUC downloads ",(0,t.jsx)(n.code,{children:"pxelinux.0"})," from TFTP on ",(0,t.jsx)(n.code,{children:"nuc-00"})]}),"\n",(0,t.jsxs)(n.li,{children:["PXE menu boots Harvester kernel + initrd from HTTP on ",(0,t.jsx)(n.code,{children:"nuc-00"})]}),"\n",(0,t.jsxs)(n.li,{children:["Harvester installer fetches its per-node config file from ",(0,t.jsx)(n.code,{children:"nuc-00"})]}),"\n",(0,t.jsx)(n.li,{children:"Automated install proceeds; node reboots into Harvester"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"per-node-config-files",children:"Per-Node Config Files"}),"\n",(0,t.jsxs)(n.p,{children:["Create one config file per node in ",(0,t.jsx)(n.code,{children:"/var/www/html/harvester/"}),". Config files follow the naming convention used in the enclave repo: ",(0,t.jsx)(n.code,{children:"config-create-nuc-01.yaml"}),", ",(0,t.jsx)(n.code,{children:"config-join-nuc-02.yaml"}),", etc."]}),"\n",(0,t.jsxs)(n.h3,{id:"config-create-nuc-01yaml-first-node--creates-cluster",children:[(0,t.jsx)(n.code,{children:"config-create-nuc-01.yaml"})," (First Node \u2014 Creates Cluster)"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'scheme_version: 1\n\nserver_url: ""  # empty = this is the first/create node\n\ntoken: "KentuckyHarvester"\n\nos:\n  hostname: nuc-01\n  password: "$6$rounds=4096$SALTSALT$HASHEDPASSWORD"  # openssl passwd -6\n  ntp_servers:\n    - 0.suse.pool.ntp.org\n    - 1.suse.pool.ntp.org\n    - 2.suse.pool.ntp.org\n  dns_nameservers:\n    - 10.10.12.9\n    - 10.10.12.8\n    - 8.8.8.8\n  ssh_authorized_keys:\n    - "ssh-ed25519 AAAAC3... enclave-admin"\n\ninstall:\n  mode: create\n  management_interface:\n    interfaces:\n      - name: enp86s0\n    method: static\n    ip: 10.10.12.101\n    subnet_mask: 255.255.252.0\n    gateway: 10.10.12.1\n    mtu: 1500\n  device: /dev/sda\n  vip: 10.10.12.100\n  vip_mode: static\n\nsystem_settings:\n  auto-disk-provision-paths: "/dev/nvme0n1"  # secondary NVMe for Longhorn\n'})}),"\n",(0,t.jsxs)(n.h3,{id:"config-join-nuc-02yaml-join-node",children:[(0,t.jsx)(n.code,{children:"config-join-nuc-02.yaml"})," (Join Node)"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'scheme_version: 1\n\nserver_url: "https://10.10.12.100"  # Harvester VIP of first node\n\ntoken: "KentuckyHarvester"\n\nos:\n  hostname: nuc-02\n  password: "$6$rounds=4096$SALTSALT$HASHEDPASSWORD"\n  ntp_servers:\n    - 0.suse.pool.ntp.org\n    - 1.suse.pool.ntp.org\n    - 2.suse.pool.ntp.org\n  dns_nameservers:\n    - 10.10.12.9\n    - 10.10.12.8\n    - 8.8.8.8\n  ssh_authorized_keys:\n    - "ssh-ed25519 AAAAC3... enclave-admin"\n\ninstall:\n  mode: join\n  management_interface:\n    interfaces:\n      - name: enp86s0\n    method: static\n    ip: 10.10.12.102\n    subnet_mask: 255.255.252.0\n    gateway: 10.10.12.1\n    mtu: 1500\n  device: /dev/sda\n\nsystem_settings:\n  auto-disk-provision-paths: "/dev/nvme0n1"\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"config-join-nuc-03.yaml"})," follows the same pattern as ",(0,t.jsx)(n.code,{children:"nuc-02"})," with hostname ",(0,t.jsx)(n.code,{children:"nuc-03"})," and IP ",(0,t.jsx)(n.code,{children:"10.10.12.103"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"generate-hashed-password",children:"Generate Hashed Password"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"openssl passwd -6 'YourSecurePassword'\n"})}),"\n",(0,t.jsx)(n.h2,{id:"installation-sequence",children:"Installation Sequence"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Critical:"})," Install nodes in order. ",(0,t.jsx)(n.code,{children:"nuc-01"})," must complete and the Harvester VIP (",(0,t.jsx)(n.code,{children:"10.10.12.100"}),") must be reachable before starting ",(0,t.jsx)(n.code,{children:"nuc-02"})," and ",(0,t.jsx)(n.code,{children:"nuc-03"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"step-1-boot-nuc-01",children:"Step 1: Boot nuc-01"}),"\n",(0,t.jsxs)(n.p,{children:["Power on ",(0,t.jsx)(n.code,{children:"nuc-01"}),". In the BIOS one-time boot menu (F7), select Network/PXE boot."]}),"\n",(0,t.jsxs)(n.p,{children:["Monitor installation progress from ",(0,t.jsx)(n.code,{children:"nuc-00"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Watch Apache access log\ntail -f /var/log/httpd/access_log | grep nuc-01\n"})}),"\n",(0,t.jsx)(n.p,{children:"Installation takes 10\u201315 minutes. The node reboots twice."}),"\n",(0,t.jsx)(n.h3,{id:"step-2-verify-nuc-01-is-up",children:"Step 2: Verify nuc-01 is up"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Harvester API should respond at VIP\ncurl -k https://10.10.12.100/ping\n# Expected: "pong"\n\n# SSH to node\nssh rancher@10.10.12.101\n\n# Check Harvester cluster health\nkubectl get nodes --kubeconfig /etc/rancher/k3s/k3s.yaml\n# Expected: nuc-01 Ready\n'})}),"\n",(0,t.jsx)(n.h3,{id:"step-3-boot-nuc-02-and-nuc-03",children:"Step 3: Boot nuc-02 and nuc-03"}),"\n",(0,t.jsxs)(n.p,{children:["Once ",(0,t.jsx)(n.code,{children:"nuc-01"})," is healthy, PXE boot ",(0,t.jsx)(n.code,{children:"nuc-02"})," and ",(0,t.jsx)(n.code,{children:"nuc-03"})," (can be done simultaneously)."]}),"\n",(0,t.jsx)(n.p,{children:"Monitor join progress:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# From nuc-01\nwatch kubectl get nodes --kubeconfig /etc/rancher/k3s/k3s.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Allow 15\u201320 minutes for both nodes to join."}),"\n",(0,t.jsx)(n.h3,{id:"step-4-retrieve-kubeconfig",children:"Step 4: Retrieve kubeconfig"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Copy Harvester kubeconfig to your workstation\nscp rancher@10.10.12.100:/etc/rancher/k3s/k3s.yaml ~/.kube/harvester-config\n\n# Update server address in kubeconfig (replace 127.0.0.1 with VIP)\nsed -i 's|https://127.0.0.1:6443|https://10.10.12.100:6443|g' ~/.kube/harvester-config\n\n# Verify\nkubectl --kubeconfig ~/.kube/harvester-config get nodes\n"})}),"\n",(0,t.jsx)(n.h2,{id:"cluster-verification",children:"Cluster Verification"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# All nodes Ready\nkubectl get nodes -o wide\n# Expected:\n# NAME    STATUS   ROLES                  AGE   VERSION\n# nuc-01  Ready    control-plane,master   ...   v1.x.x\n# nuc-02  Ready    control-plane,master   ...   v1.x.x\n# nuc-03  Ready    control-plane,master   ...   v1.x.x\n\n# Longhorn storage (may take a few minutes to appear)\nkubectl get sc\n# Expected: harvester-longhorn (default)\n\n# Check Longhorn pods\nkubectl get pods -n longhorn-system\n\n# Harvester UI accessible\nopen https://10.10.12.100\n"})}),"\n",(0,t.jsx)(n.p,{children:"Login to the Harvester UI with the password set in the config files."}),"\n",(0,t.jsx)(n.h2,{id:"post-install-add-longhorn-disks",children:"Post-Install: Add Longhorn Disks"}),"\n",(0,t.jsxs)(n.p,{children:["If the secondary NVMe (",(0,t.jsx)(n.code,{children:"/dev/nvme0n1"}),") was not automatically provisioned:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Navigate to Harvester UI \u2192 ",(0,t.jsx)(n.strong,{children:"Host"})," \u2192 select a node"]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Edit"})," \u2192 ",(0,t.jsx)(n.strong,{children:"Storage"})]}),"\n",(0,t.jsxs)(n.li,{children:["Add ",(0,t.jsx)(n.code,{children:"/dev/nvme0n1"})," as a data disk"]}),"\n",(0,t.jsx)(n.li,{children:"Repeat for all nodes"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Longhorn will format and add these disks to its storage pool."}),"\n",(0,t.jsxs)(n.p,{children:["Proceed to ",(0,t.jsx)(n.a,{href:"/docs/day-1/rancher-manager",children:"Rancher Manager"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>c,x:()=>i});var r=s(6540);const t={},o=r.createContext(t);function c(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);